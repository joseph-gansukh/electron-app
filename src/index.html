<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Hello World!</title>
    <link rel="stylesheet" href="index.css">
</head>

<body>
    <h1>LFC PO Label Generator</h1>
    <form>
        <input type="file" name="file" id="file" accept=".csv" onchange="handleFiles(this.files)">
    </form>

    <div id="main"></div>
    <img id="barcode" />

    <script>
        const parse = require('csv-parse')
        const moment = require('moment')
        const JsBarcode = require('jsbarcode');
        // const {
        //     createCanvas
        // } = require("canvas");
        const form = document.querySelector('form')

        function handleFiles(files) {
            console.log('files: ', files);
            // Check for the various File API support.
            if (window.FileReader) {
                // FileReader are supported.
                getAsText(files[0]);
            } else {
                alert('FileReader are not supported in this browser.');
            }
        }

        function getAsText(fileToRead) {
            var reader = new FileReader();
            // Read file into memory as UTF-8      
            reader.readAsText(fileToRead);
            // Handle errors load
            reader.onload = loadHandler;
            reader.onerror = errorHandler;
        }

        function loadHandler(event) {
            var csv = event.target.result;
            processData(csv);
        }

        function processData(csv) {
            var allTextLines = csv.split(/\r\n|\n/);
            var lines = [];
            for (var i = 0; i < allTextLines.length; i++) {
                var data = allTextLines[i].split(';');
                var tarr = [];
                for (var j = 0; j < data.length; j++) {
                    tarr.push(data[j].split(','));
                }
                lines.push(tarr);
            }

            const flatCsvLines = lines.flat()

            const nameIdx = 0
            const qtyIdx = flatCsvLines[0].indexOf("\"Qty\"")
            const barcodeIdx = flatCsvLines[0].indexOf("\"Bar Code\"")

            const productsOjb = []
            const regex = /\"/g
            for (let i = 1; i < flatCsvLines.length; i++) {
                if (flatCsvLines[i][barcodeIdx]) {
                    productsOjb.push({
                        product: flatCsvLines[i - 1][nameIdx].replace(regex, '').split(" \(")[0],
                        qty: parseInt(10, flatCsvLines[i][qtyIdx].replace(regex, '')),
                        barcode: flatCsvLines[i][barcodeIdx].replace(regex, ''),
                        date: `Rcvd on: ${moment().format("MM/DD/YYYY")}`
                    })
                }
            }

            const productsObjList = []
            productsOjb.map(obj => {
                for (let i = 0; i < obj.qty; i++) {
                    productsObjList.push({
                        name: obj.product,
                        barcode: obj.barcode,
                        date: obj.date
                    })
                }
            })
            console.log('productsOjb: ', productsOjb);
            console.log('productsObjList: ', productsObjList);

            const mainContainerDiv = document.querySelector('#main')
            productsObjList.map(product => {

                const productDiv = document.createElement('div')

                const nameH2 = document.createElement('h2')
                nameH2.innerText = product.name

                const date = document.createElement('p')
                date.innerHTML = product.date

                const barcode = document.createElement('img')
                JsBarcode(barcode, `${product.barcode}`);


                productDiv.appendChild(nameH2)
                productDiv.appendChild(date)
                productDiv.appendChild(barcode)

                mainContainerDiv.appendChild(productDiv)

                // const barcodeText = JsBarcode("#barcode", `${product.barcode}`, {
                //     format: "CODE39",
                //     mod43: true
                // });
                // var element = document.getElementById("barcode");
                // JsBarcode(element, `${product.barcode}`);

            })
        }

        function errorHandler(evt) {
            if (evt.target.error.name == "NotReadableError") {
                alert("Cannot read file !");
            }
        }
    </script>
</body>

</html>